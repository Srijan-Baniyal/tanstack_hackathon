name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
        run: pnpm build

      - name: Prepare static site
        run: |
          # Move client assets to root for proper path resolution
          mkdir -p dist_deploy
          cp -r dist/client/assets dist_deploy/
          
          echo "Looking for entry points in dist_deploy/assets:"
          ls -lh dist_deploy/assets/ | grep -E "(index|main).*\.(js|css)" || echo "No entry files found"
          
          cd dist_deploy
          
          # Look for entry point files - prioritize index over main
          INDEX_JS=$(ls assets/index-*.js 2>/dev/null | head -n 1)
          MAIN_JS=$(ls assets/main-*.js 2>/dev/null | head -n 1)
          DASHBOARD_JS=$(ls assets/dashboard-*.js 2>/dev/null | head -n 1)
          INDEX_CSS=$(ls assets/index-*.css 2>/dev/null | head -n 1)
          STYLES_CSS=$(ls assets/styles-*.css 2>/dev/null | head -n 1)
          DASHBOARD_CSS=$(ls assets/dashboard-*.css 2>/dev/null | head -n 1)
          
          # Use whichever JS/CSS file we found (prefer index)
          ENTRY_JS="${INDEX_JS:-${MAIN_JS:-${DASHBOARD_JS}}}"
          ENTRY_CSS="${INDEX_CSS:-${STYLES_CSS:-${DASHBOARD_CSS}}}"
          
          echo "Using:"
          echo "  JS: $ENTRY_JS"
          echo "  CSS: $ENTRY_CSS"
          
          # Create index.html
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>MeshMind</title>
              __CSS_LINK__
            </head>
            <body>
              <div id="root"></div>
              __JS_SCRIPT__
            </body>
          </html>
          HTMLEOF
          
          # Add CSS if found
          if [ -n "$ENTRY_CSS" ]; then
            sed -i "s|__CSS_LINK__|<link rel=\"stylesheet\" crossorigin href=\"/$ENTRY_CSS\">|" index.html
          else
            sed -i "s|__CSS_LINK__||" index.html
          fi
          
          # Add JS if found
          if [ -n "$ENTRY_JS" ]; then
            sed -i "s|__JS_SCRIPT__|<script type=\"module\" crossorigin src=\"/$ENTRY_JS\"></script>|" index.html
          else
            sed -i "s|__JS_SCRIPT__||" index.html
          fi
          
          # Copy for SPA routing
          cp index.html 404.html
          
          echo "âœ“ Created index.html"
          echo "Content:"
          cat index.html
          
          cd ..
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist_deploy

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
